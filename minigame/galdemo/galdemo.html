<!DOCTYPE html>
<html ng-app="noteapp">
<head>
<meta charset="utf-8">
  <link href="gal_style.css" rel="stylesheet" type="text/css" />
</head>
<body>

<div class="bk" id="bk1" ></div>
<div class="bk" id="bk2" ></div>
<div id="characontainer" ></div>

	<div class="dialogbox" onclick="onDialogboxClicked();">
		<div id="namebox">
			<p align="center" style="color:white;font-size:16px;">udspj</p>
		</div>
		<p id="textbox" style="color:white;font-size:16px;margin:20px;"></p>
		<p id="nexttext" style="color:white;right:20px;bottom:0px;position:absolute;">↪</p>
	</div>
		<div class="menubox">
			<div class="menu" style="border-radius: 0px 10px 0px 0px;" onclick="menuClickHistory();">历史</div>
			<div class="menu" onclick="menuClickPrevSelect();">上一个选项</div>
			<div class="menu" onclick="menuClickRestart();">重新开始</div>
			<div class="menu" id="menuauto" style="border-radius: 0px 0px 10px 0px;" onclick="menuClickAuto();">自动</div>
		</div>

<div class='blackcover' id='blackcoverup' style="top:0;"></div> 
<div class='blackcover' id='blackcoverdown' style="bottom:0;"></div> 

<script language='javascript' src="Selections.js"></script>
<script language='javascript' src="History.js"></script>
<script language='javascript' src="Characters.js"></script>
<script language='javascript' src="resource.js"></script>
<script language='javascript' src="DialogueText.js"></script>
<script src="preloadjs-0.6.2.min.js"></script>
<script type="text/javascript">


        var _LoadingHtml = '<table id="loadingDiv" width="100%" height="100%" topmargin="0" leftmargin="0" style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000;"><tr><td align="absmiddle"><p id="loadingtext" height=100 align=center style="color:white;font-size:20px;">loading...</p></td></tr></table>';
        document.write(_LoadingHtml);
//         document.onreadystatechange = completeLoading;
//         function completeLoading() {
//             if (document.readyState == "complete") {
//                 var loadingMask = document.getElementById('loadingDiv');
//                 loadingMask.parentNode.removeChild(loadingMask);
// start();
//             }
//         }







		var manifest = ([
     {id: "bk1", src:"bk1.jpg"},
     {id: "bk2", src:"bk2.jpg"}
 ]);//["bk1.jpg", "bk2.jpg", "chara1.png", "chara2.png", "chara1exp1.png", "chara1exp2.png", "chara2exp1.png", "chara2exp2.png"];

		preload = new createjs.LoadQueue(true);

		// Use this instead to use tag loading
		//preload = new createjs.PreloadJS(false);
			var loadingtext = document.getElementById('loadingtext');

		preload.on("progress", handleProgress);
		preload.on("complete", handleComplete);
		preload.loadManifest(manifest);
		function handleProgress(event) {
			console.log("handleProgress:"+event.loaded);
			loadingtext.innerText = "loading... "+event.loaded*100+"%";
		}
		function handleComplete(event) {
			console.log("handleComplete:");
			var loadingMask = document.getElementById('loadingDiv');
                loadingMask.parentNode.removeChild(loadingMask);
start();
		}



function menuClickHistory() {
	historydialog.showHistory();
}

function menuClickPrevSelect() {
	if(lastSelectIndex.length == 0) {
		return
	}
	showPrevSelection(lastSelectIndex[lastSelectIndex.length-1]);
	// lastSelectIndex.pop();
}

function menuClickRestart() {
	var r=confirm("确定要RE：0重新开始吗？");
if (r==true)
  {
	  if(auto.innerText == "取消自动") {
		menuClickAuto();
	}
	  nowindex = 0;
	  showNextDialogue();
  }
}

	var auto = document.getElementById('menuauto');
		window.addEventListener('onAutoTextFinished', autoTextHandler, false);
function menuClickAuto() {
	// console.log("menuClickAuto");
	var textinterval;
	if(auto.innerText == "自动") {
		auto.innerText = "取消自动";
		showNextDialogue();
	}else{
		// console.log('取消自动');
		auto.innerText = "自动";
		// window.removeEventListener('onAutoTextFinished', autoTextHandler, false);
				clearInterval(textinterval);
	}
}
function autoTextHandler (e) { 
			console.log('onAutoTextFinished');
			historydialog.addHistory(e.detail);
        nowindex++;
			if(auto.innerText == "取消自动") {
			textinterval = setInterval(function(){ 
				showNextDialogue(); 
				clearInterval(textinterval); 
			}, 1000);
		}
		}


		





var characters = new Characters();
	var historydialog = new History();
	var dialogue = new DialogueText();


var blackcoverup = document.getElementById('blackcoverup');//document.getElementsByClassName('blackcoverup')[0];
var blackcoverdown = document.getElementById('blackcoverdown');//document.getElementsByClassName('blackcoverdown')[0];
var bk1 = document.getElementById('bk1');
var bk2 = document.getElementById('bk2');

var name = document.getElementById('namebox');


	function start() {
		blackcoverup.classList.add('horizTranslate');
		blackcoverdown.classList.add('horizTranslate');

		bk1.classList.add('fadein');
				
		document.getElementById("nexttext").style.display = "none";

		showNextDialogue();

		window.addEventListener('onSelectClick', function (e) { 
			// console.log('eventttttttt'+e.detail);
			nowindex = e.detail;
			showNextDialogue();
		}, false);
}

var lastSelectIndex = [];
var nowindex = 0;
function onDialogboxClicked(){
	if(auto.innerText == "取消自动") {
		return;
	}
	showNextDialogue();
}
function showNextDialogue() {
	console.log("showNextDialogue");
	var res = ScriptList[nowindex];
	if(!res) {
		console.log("end");
		if(auto.innerText == "取消自动") {
			menuClickAuto();
		}
		return;
	}
	if(!dialogue.isTextShowed) {
		dialogue.isclicked = true;
		dialogue.showDialogueText(res["dialogue"]);
		return;
	}
	name.innerText = res["name"]
	changeBackground(res["background"])
	dialogue.showDialogueText(res["dialogue"]);
	characters.showCharacters(res["character"]);
	if(res["selections"]) {
		var selectbranch = new SelectionBranch();
		selectbranch.showSelections(res["selections"]);
			if(auto.innerText == "取消自动") {
				menuClickAuto();
			}
		lastSelectIndex[lastSelectIndex.length] = nowindex;
	}
}

function showPrevSelection(previndex) {
	var res = ScriptList[previndex];
	name.innerText = res["name"]
	changeBackground(res["background"])
	console.log(res["dialogue"] + " " + previndex);
	dialogue.showDialogueText(res["dialogue"]);
	characters.showCharacters(res["character"]);
	if(res["selections"]) {
		var selectbranch = new SelectionBranch();
		selectbranch.showSelections(res["selections"]);
			if(auto.innerText == "取消自动") {
				menuClickAuto();
			}
	}
}

// var isclicked = false;
var nowimg = "";
function changeBackground(img) {
	if(nowimg == img) { return }
	nowimg = img;
	if(bk1.classList.contains('fadein')) {
		console.log("preload img "+img+","+preload.getResult(img));
		console.log("preload img "+img+","+preload.getResult(img).src);
		bk2.style.backgroundImage = "url('"+preload.getResult(img).src+"')";
		bk1.classList.remove('fadein');
		bk1.classList.add('fadeout');
		bk2.classList.remove('fadeout');
		bk2.classList.add('fadein');
	}else{
		bk1.style.backgroundImage = "url('"+preload.getResult(img).src+"')";
		bk2.classList.remove('fadein');
		bk2.classList.add('fadeout');
		bk1.classList.remove('fadeout');
		bk1.classList.add('fadein');
	}
}











// var isTextShowed = true;
// var startAdd;
// function showDialogueText(text) {
// 	isTextShowed = false;
// 	var textword = text;
// 	var textbox=document.getElementById("textbox");
// 	if (isclicked) {
// 		textbox.innerText=textword;
// 		isclicked = false;
// 		// console.log('asdfsafsassssss');
// 	// 	isTextShowed = true;
// 	// 	clearInterval(startAdd);
//  //            document.getElementById("nexttext").style.display = "";
//  //            historydialog.addHistory(textword);
// 	// nowindex ++;
//         	next(textword);
// 		return;
// 	}
//     var textlength=1;
//     function textwordAdd () {
//     	document.getElementById("nexttext").style.display = "none";
//         textbox.innerText=textword.substring(0, textlength);
//         if (textlength<=textword.length) {
//             textlength++;
//         }else{
//         	next(textword);
//  //            clearInterval(startAdd);
//  //            isTextShowed = true;
//  //            document.getElementById("nexttext").style.display = "";
//  //            historydialog.addHistory(textword);
// 	// nowindex ++;
//         };
//     }
// 		console.log('setInterval');
//     startAdd=setInterval(textwordAdd, 20);
// }
// function next(text){
// 	clearInterval(startAdd);
//             isTextShowed = true;
//             document.getElementById("nexttext").style.display = "";
//             // historydialog.addHistory(text);
// 	// nowindex ++;

// 	var selectEvent = new CustomEvent('onAutoTextFinished', {  detail: text  });
//             window.dispatchEvent(selectEvent);
// }


</script>

</body>
</html>
