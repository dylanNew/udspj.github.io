<!DOCTYPE html>
<html ng-app="noteapp">
<head>
<meta charset="utf-8">
  <link href="gal_style.css" rel="stylesheet" type="text/css" />
</head>
<body>

<div class="bk" id="bk1" ></div>
<div class="bk" id="bk2" ></div>
<div id="characontainer" ></div>

	<div id="iddialogbox" class="dialogbox" onclick="onDialogboxClicked();">
		<div id="namebox">
			<p align="center" style="color:white;font-size:16px;">udspj</p>
		</div>
		<p id="textbox" style="color:white;font-size:16px;margin:20px;"></p>
		<p id="nexttext" style="color:white;right:20px;bottom:0px;position:absolute;">↪</p>
	</div>
		<div class="menubox">
			<div class="menu" style="border-radius: 0px 10px 0px 0px;" onclick="menuClickHistory();">历史</div>
			<div class="menu" onclick="menuClickPrevSelect();">上一个选项</div>
			<div class="menu" onclick="menuClickRestart();">重新开始</div>
			<div class="menu" id="menuauto" style="border-radius: 0px 0px 10px 0px;" onclick="menuClickAuto();">自动</div>
		</div>

<div class='blackcover' id='blackcoverup' style="top:0;"></div> 
<div class='blackcover' id='blackcoverdown' style="bottom:0;"></div> 

<script language='javascript' src="Selections.js"></script>
<script language='javascript' src="History.js"></script>
<script language='javascript' src="Characters.js"></script>
<script language='javascript' src="resource.js"></script>
<script language='javascript' src="DialogueText.js"></script>
<script type="text/javascript">


function menuClickHistory() {
	historydialog.showHistory();
}

function menuClickPrevSelect() {
	if(lastSelectIndex.length == 0) {
		return
	}
	showPrevSelection(lastSelectIndex[lastSelectIndex.length-1]);
	// lastSelectIndex.pop();
}

function menuClickRestart() {
	var r=confirm("确定要RE：0重新开始吗？");
if (r==true)
  {
	  if(auto.innerText == "取消自动") {
		menuClickAuto();
	}
	  nowindex = 0;
	  showNextDialogue();
  }
}

	var auto = document.getElementById('menuauto');
		window.addEventListener('onAutoTextFinished', autoTextHandler, false);
function menuClickAuto() {
	// console.log("menuClickAuto");
	var textinterval;
	if(auto.innerText == "自动") {
		auto.innerText = "取消自动";
		showNextDialogue();
	}else{
		// console.log('取消自动');
		auto.innerText = "自动";
		// window.removeEventListener('onAutoTextFinished', autoTextHandler, false);
				clearInterval(textinterval);
	}
}
function autoTextHandler (e) { 
			console.log('onAutoTextFinished');
			historydialog.addHistory(e.detail);
        nowindex++;
			if(auto.innerText == "取消自动") {
			textinterval = setInterval(function(){ 
				showNextDialogue(); 
				clearInterval(textinterval); 
			}, 1000);
		}
		}


		

//获取浏览器页面可见高度和宽度

        var _PageHeight = document.documentElement.clientHeight,
            _PageWidth = document.documentElement.clientWidth;
        //计算loading框距离顶部和左部的距离（loading框的宽度为215px，高度为61px）
        var _LoadingTop = _PageHeight > 61 ? (_PageHeight - 61) / 2 : 0,
            _LoadingLeft = _PageWidth > 215 ? (_PageWidth - 215) / 2 : 0;
        //在页面未加载完毕之前显示的loading Html自定义内容
        var _LoadingHtml = '<div id="loadingDiv" style="position:absolute;left:0;width:100%;height:' + _PageHeight + 'px;top:0;background:#f3f8ff;opacity:0.8;filter:alpha(opacity=80);z-index:10000;"><div style="position: absolute; cursor1: wait; left: ' + _LoadingLeft + 'px; top:' + _LoadingTop + 'px; width: auto; height: 57px; line-height: 57px; padding-left: 50px; padding-right: 5px; background: #fff url(/Content/loading.gif) no-repeat scroll 5px 10px; border: 2px solid #95B8E7; color: #696969; font-family:\'Microsoft YaHei\';">页面加载中，请等待...</div></div>';
        //呈现loading效果
        document.write(_LoadingHtml);
        //window.onload = function () {
        //    var loadingMask = document.getElementById('loadingDiv');
        //    loadingMask.parentNode.removeChild(loadingMask);
        //};
        //监听加载状态改变
        document.onreadystatechange = completeLoading;
        //加载状态为complete时移除loading效果
        function completeLoading() {
            if (document.readyState == "complete") {
                var loadingMask = document.getElementById('loadingDiv');
                loadingMask.parentNode.removeChild(loadingMask);
// console.log('cccccccc');
start();
            }
        }



var characters = new Characters();
	var historydialog = new History();
	var dialogue = new DialogueText();


var blackcoverup = document.getElementById('blackcoverup');//document.getElementsByClassName('blackcoverup')[0];
var blackcoverdown = document.getElementById('blackcoverdown');//document.getElementsByClassName('blackcoverdown')[0];
var bk1 = document.getElementById('bk1');
var bk2 = document.getElementById('bk2');

var name = document.getElementById('namebox');


	function start() {
		blackcoverup.classList.add('horizTranslate');
		blackcoverdown.classList.add('horizTranslate');

		bk1.classList.add('fadein');
				
		document.getElementById("nexttext").style.display = "none";

		showNextDialogue();

		window.addEventListener('onSelectClick', function (e) { 
			// console.log('eventttttttt'+e.detail);
			nowindex = e.detail;
			showNextDialogue();
		}, false);
}

var lastSelectIndex = [];
var nowindex = 0;
function onDialogboxClicked(){
	if(auto.innerText == "取消自动") {
		return;
	}
	showNextDialogue();
}
function showNextDialogue() {
	console.log("showNextDialogue");
	var res = ScriptList[nowindex];
	if(!res) {
		console.log("end");
		if(auto.innerText == "取消自动") {
			menuClickAuto();
		}
		return;
	}
	if(!dialogue.isTextShowed) {
		dialogue.isclicked = true;
		dialogue.showDialogueText(res["dialogue"]);
		return;
	}
	name.innerText = res["name"]
	changeBackground(res["background"])
	dialogue.showDialogueText(res["dialogue"]);
	characters.showCharacters(res["character"]);
	if(res["selections"]) {
		var selectbranch = new SelectionBranch();
		selectbranch.showSelections(res["selections"]);
			if(auto.innerText == "取消自动") {
				menuClickAuto();
			}
		lastSelectIndex[lastSelectIndex.length] = nowindex;
	}
}

function showPrevSelection(previndex) {
	var res = ScriptList[previndex];
	name.innerText = res["name"]
	changeBackground(res["background"])
	console.log(res["dialogue"] + " " + previndex);
	dialogue.showDialogueText(res["dialogue"]);
	characters.showCharacters(res["character"]);
	if(res["selections"]) {
		var selectbranch = new SelectionBranch();
		selectbranch.showSelections(res["selections"]);
			if(auto.innerText == "取消自动") {
				menuClickAuto();
			}
	}
}

// var isclicked = false;
var nowimg = "";
function changeBackground(img) {
	if(nowimg == img) { return }
	nowimg = img;
	if(bk1.classList.contains('fadein')) {
		bk2.style.backgroundImage = "url('"+img+"')";
		bk1.classList.remove('fadein');
		bk1.classList.add('fadeout');
		bk2.classList.remove('fadeout');
		bk2.classList.add('fadein');
	}else{
		bk1.style.backgroundImage = "url('"+img+"')";
		bk2.classList.remove('fadein');
		bk2.classList.add('fadeout');
		bk1.classList.remove('fadeout');
		bk1.classList.add('fadein');
	}
}











// var isTextShowed = true;
// var startAdd;
// function showDialogueText(text) {
// 	isTextShowed = false;
// 	var textword = text;
// 	var textbox=document.getElementById("textbox");
// 	if (isclicked) {
// 		textbox.innerText=textword;
// 		isclicked = false;
// 		// console.log('asdfsafsassssss');
// 	// 	isTextShowed = true;
// 	// 	clearInterval(startAdd);
//  //            document.getElementById("nexttext").style.display = "";
//  //            historydialog.addHistory(textword);
// 	// nowindex ++;
//         	next(textword);
// 		return;
// 	}
//     var textlength=1;
//     function textwordAdd () {
//     	document.getElementById("nexttext").style.display = "none";
//         textbox.innerText=textword.substring(0, textlength);
//         if (textlength<=textword.length) {
//             textlength++;
//         }else{
//         	next(textword);
//  //            clearInterval(startAdd);
//  //            isTextShowed = true;
//  //            document.getElementById("nexttext").style.display = "";
//  //            historydialog.addHistory(textword);
// 	// nowindex ++;
//         };
//     }
// 		console.log('setInterval');
//     startAdd=setInterval(textwordAdd, 20);
// }
// function next(text){
// 	clearInterval(startAdd);
//             isTextShowed = true;
//             document.getElementById("nexttext").style.display = "";
//             // historydialog.addHistory(text);
// 	// nowindex ++;

// 	var selectEvent = new CustomEvent('onAutoTextFinished', {  detail: text  });
//             window.dispatchEvent(selectEvent);
// }


</script>

</body>
</html>
